# Forzar modo STA (Single-Thread Apartment) requerido para WinForms
if ($host.Runspace.ApartmentState -ne "STA") {
    Write-Host "Reiniciando en modo STA..." -ForegroundColor Yellow
    powershell -STA -ExecutionPolicy Bypass -File $PSCommandPath
    exit
}

try {
    Add-Type -AssemblyName System.Windows.Forms
    Add-Type -AssemblyName System.Drawing
} catch {
    Write-Host "Error cargando librer铆as: $_" -ForegroundColor Red
    Read-Host "Presiona Enter para salir"
    exit
}

# Importar funciones de Windows API
try {
    Add-Type @"
using System;
using System.Runtime.InteropServices;
public class NativeMethods {
    [DllImport("user32.dll")]
    public static extern void mouse_event(int dwFlags, int dx, int dy, int dwData, int dwExtraInfo);
    
    [DllImport("user32.dll")]
    public static extern short GetAsyncKeyState(int vKey);
    
    [DllImport("user32.dll", SetLastError = true)]
    public static extern int SetWindowLong(IntPtr hWnd, int nIndex, int dwNewLong);
    
    [DllImport("user32.dll", SetLastError = true)]
    public static extern int GetWindowLong(IntPtr hWnd, int nIndex);
    
    [DllImport("dwmapi.dll", PreserveSig = true)]
    public static extern int DwmSetWindowAttribute(IntPtr hwnd, int attr, ref int attrValue, int attrSize);
    
    public const int MOUSEEVENTF_LEFTDOWN = 0x02;
    public const int MOUSEEVENTF_LEFTUP = 0x04;
    public const int MOUSEEVENTF_RIGHTDOWN = 0x08;
    public const int MOUSEEVENTF_RIGHTUP = 0x10;
    
    public const int GWL_EXSTYLE = -20;
    public const int WS_EX_TOOLWINDOW = 0x00000080;
    public const int WS_EX_NOACTIVATE = 0x08000000;
    public const int DWMWA_EXCLUDED_FROM_PEEK = 12;
    public const int DWMWA_CLOAK = 13;
}
"@
} catch {
    # Tipo ya existe, continuar
}

# Variables globales
$script:leftClickTimer = New-Object System.Windows.Forms.Timer
$script:rightClickTimer = New-Object System.Windows.Forms.Timer
$script:keyMonitorTimer = New-Object System.Windows.Forms.Timer
$script:leftHotkey = 0x00
$script:rightHotkey = 0x00
$script:leftEnabled = $false
$script:rightEnabled = $false
$script:leftPreviousState = $false
$script:rightPreviousState = $false
$script:leftListeningMode = $false
$script:rightListeningMode = $false
$script:stealthMode = $false

# Funci贸n para obtener el nombre de la tecla
function Get-KeyName {
    param([int]$keyCode)
    
    $keyNames = @{
        0x01 = "LMB"
        0x02 = "RMB"
        0x04 = "MMB"
        0x05 = "MB4"
        0x06 = "MB5"
        0x20 = "Space"
        0x10 = "Shift"
        0x11 = "Ctrl"
        0x12 = "Alt"
        0x41 = "A"; 0x42 = "B"; 0x43 = "C"; 0x44 = "D"; 0x45 = "E"
        0x46 = "F"; 0x47 = "G"; 0x48 = "H"; 0x49 = "I"; 0x4A = "J"
        0x4B = "K"; 0x4C = "L"; 0x4D = "M"; 0x4E = "N"; 0x4F = "O"
        0x50 = "P"; 0x51 = "Q"; 0x52 = "R"; 0x53 = "S"; 0x54 = "T"
        0x55 = "U"; 0x56 = "V"; 0x57 = "W"; 0x58 = "X"; 0x59 = "Y"
        0x5A = "Z"
        0x70 = "F1"; 0x71 = "F2"; 0x72 = "F3"; 0x73 = "F4"
        0x74 = "F5"; 0x75 = "F6"; 0x76 = "F7"; 0x77 = "F8"
    }
    
    if ($keyNames.ContainsKey($keyCode)) {
        return $keyNames[$keyCode]
    }
    return "Key"
}

# Funci贸n para capturar tecla presionada (excluyendo botones del mouse si est谩n configurados)
function Get-PressedKey {
    param([bool]$excludeLeftClick = $false, [bool]$excludeRightClick = $false)
    
    for ($i = 0x01; $i -le 0xFE; $i++) {
        # Excluir bot贸n izquierdo si se est谩 configurando left click
        if ($excludeLeftClick -and $i -eq 0x01) { continue }
        # Excluir bot贸n derecho si se est谩 configurando right click
        if ($excludeRightClick -and $i -eq 0x02) { continue }
        
        $state = [NativeMethods]::GetAsyncKeyState($i)
        if (($state -band 0x8000) -ne 0) {
            return $i
        }
    }
    return 0
}

# Funciones de click
function Invoke-LeftClick {
    [NativeMethods]::mouse_event([NativeMethods]::MOUSEEVENTF_LEFTDOWN, 0, 0, 0, 0)
    [NativeMethods]::mouse_event([NativeMethods]::MOUSEEVENTF_LEFTUP, 0, 0, 0, 0)
}

function Invoke-RightClick {
    [NativeMethods]::mouse_event([NativeMethods]::MOUSEEVENTF_RIGHTDOWN, 0, 0, 0, 0)
    [NativeMethods]::mouse_event([NativeMethods]::MOUSEEVENTF_RIGHTUP, 0, 0, 0, 0)
}

# Monitor de teclas
function Update-KeyStates {
    # Monitor click izquierdo
    if ($script:leftEnabled -and $script:leftHotkey -ne 0x00) {
        $keyState = [NativeMethods]::GetAsyncKeyState($script:leftHotkey)
        $isPressed = ($keyState -band 0x8000) -ne 0
        
        if ($isPressed -and -not $script:leftPreviousState) {
            $script:leftClickTimer.Start()
        } elseif (-not $isPressed -and $script:leftPreviousState) {
            $script:leftClickTimer.Stop()
        }
        
        $script:leftPreviousState = $isPressed
    }
    
    # Monitor click derecho
    if ($script:rightEnabled -and $script:rightHotkey -ne 0x00) {
        $keyState = [NativeMethods]::GetAsyncKeyState($script:rightHotkey)
        $isPressed = ($keyState -band 0x8000) -ne 0
        
        if ($isPressed -and -not $script:rightPreviousState) {
            $script:rightClickTimer.Start()
        } elseif (-not $isPressed -and $script:rightPreviousState) {
            $script:rightClickTimer.Stop()
        }
        
        $script:rightPreviousState = $isPressed
    }
    
    # Modo escucha para tecla izquierda
    if ($script:leftListeningMode) {
        $pressedKey = Get-PressedKey -excludeLeftClick $true
        if ($pressedKey -ne 0) {
            $script:leftHotkey = $pressedKey
            $keyName = Get-KeyName $pressedKey
            $leftKeyLabel.Text = $keyName
            $leftKeyLabel.ForeColor = [System.Drawing.Color]::White
            $leftKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
            $script:leftListeningMode = $false
            $script:leftEnabled = $true
            Start-Sleep -Milliseconds 200
        }
    }
    
    # Modo escucha para tecla derecha
    if ($script:rightListeningMode) {
        $pressedKey = Get-PressedKey -excludeRightClick $true
        if ($pressedKey -ne 0) {
            $script:rightHotkey = $pressedKey
            $keyName = Get-KeyName $pressedKey
            $rightKeyLabel.Text = $keyName
            $rightKeyLabel.ForeColor = [System.Drawing.Color]::White
            $rightKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
            $script:rightListeningMode = $false
            $script:rightEnabled = $true
            Start-Sleep -Milliseconds 200
        }
    }
}

# Crear formulario
$form = New-Object System.Windows.Forms.Form
$form.Text = "Icon1cClicker"
$form.Size = New-Object System.Drawing.Size(340, 270)
$form.StartPosition = "CenterScreen"
$form.FormBorderStyle = "None"
$form.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
$form.Font = New-Object System.Drawing.Font("Arial", 9)
$form.TopMost = $false
$form.ShowInTaskbar = $true

# Hacer el formulario arrastrable
$script:dragging = $false
$script:dragCursor = [System.Drawing.Point]::Empty
$script:dragForm = [System.Drawing.Point]::Empty

$form.Add_MouseDown({
    if ($_.Button -eq [System.Windows.Forms.MouseButtons]::Left -and $_.Y -lt 40) {
        $script:dragging = $true
        $script:dragCursor = [System.Windows.Forms.Cursor]::Position
        $script:dragForm = $form.Location
    }
})

$form.Add_MouseMove({
    if ($script:dragging) {
        $diff = [System.Drawing.Point]::new(
            [System.Windows.Forms.Cursor]::Position.X - $script:dragCursor.X,
            [System.Windows.Forms.Cursor]::Position.Y - $script:dragCursor.Y
        )
        $form.Location = [System.Drawing.Point]::new(
            $script:dragForm.X + $diff.X,
            $script:dragForm.Y + $diff.Y
        )
    }
})

$form.Add_MouseUp({
    if ($_.Button -eq [System.Windows.Forms.MouseButtons]::Left) {
        $script:dragging = $false
    }
})

# T铆tulo
$titleLabel = New-Object System.Windows.Forms.Label
$titleLabel.Location = New-Object System.Drawing.Point(15, 12)
$titleLabel.Size = New-Object System.Drawing.Size(250, 28)
$titleLabel.Text = "юヰゐ"
$titleLabel.Font = New-Object System.Drawing.Font("Arial", 14, [System.Drawing.FontStyle]::Bold)
$titleLabel.ForeColor = [System.Drawing.Color]::White
$form.Controls.Add($titleLabel)

# Bot贸n Discord
$discordBtn = New-Object System.Windows.Forms.Label
$discordBtn.Location = New-Object System.Drawing.Point(265, 10)
$discordBtn.Size = New-Object System.Drawing.Size(28, 28)
$discordBtn.Text = ""
$discordBtn.ForeColor = [System.Drawing.Color]::FromArgb(88, 101, 242)
$discordBtn.Font = New-Object System.Drawing.Font("Segoe UI", 16)
$discordBtn.TextAlign = "MiddleCenter"
$discordBtn.Cursor = [System.Windows.Forms.Cursors]::Hand
$form.Controls.Add($discordBtn)

# Bot贸n cerrar
$closeBtn = New-Object System.Windows.Forms.Label
$closeBtn.Location = New-Object System.Drawing.Point(298, 8)
$closeBtn.Size = New-Object System.Drawing.Size(32, 32)
$closeBtn.Text = ""
$closeBtn.ForeColor = [System.Drawing.Color]::White
$closeBtn.Font = New-Object System.Drawing.Font("Arial", 20, [System.Drawing.FontStyle]::Bold)
$closeBtn.TextAlign = "MiddleCenter"
$closeBtn.Cursor = [System.Windows.Forms.Cursors]::Hand
$form.Controls.Add($closeBtn)

# Left Click Row
$leftLabel = New-Object System.Windows.Forms.Label
$leftLabel.Location = New-Object System.Drawing.Point(20, 58)
$leftLabel.Size = New-Object System.Drawing.Size(65, 20)
$leftLabel.Text = "Left click"
$leftLabel.ForeColor = [System.Drawing.Color]::FromArgb(130, 130, 130)
$leftLabel.Font = New-Object System.Drawing.Font("Arial", 9)
$form.Controls.Add($leftLabel)

$leftKeyLabel = New-Object System.Windows.Forms.Label
$leftKeyLabel.Location = New-Object System.Drawing.Point(100, 55)
$leftKeyLabel.Size = New-Object System.Drawing.Size(80, 26)
$leftKeyLabel.Text = "none"
$leftKeyLabel.ForeColor = [System.Drawing.Color]::FromArgb(100, 100, 100)
$leftKeyLabel.Font = New-Object System.Drawing.Font("Arial", 10)
$leftKeyLabel.Cursor = [System.Windows.Forms.Cursors]::Hand
$leftKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
$leftKeyLabel.TextAlign = "MiddleCenter"
$form.Controls.Add($leftKeyLabel)

$leftCpsLabel = New-Object System.Windows.Forms.Label
$leftCpsLabel.Location = New-Object System.Drawing.Point(280, 58)
$leftCpsLabel.Size = New-Object System.Drawing.Size(35, 20)
$leftCpsLabel.Text = "10"
$leftCpsLabel.ForeColor = [System.Drawing.Color]::White
$leftCpsLabel.Font = New-Object System.Drawing.Font("Arial", 11, [System.Drawing.FontStyle]::Bold)
$leftCpsLabel.TextAlign = "MiddleRight"
$form.Controls.Add($leftCpsLabel)

$leftSlider = New-Object System.Windows.Forms.TrackBar
$leftSlider.Location = New-Object System.Drawing.Point(20, 83)
$leftSlider.Size = New-Object System.Drawing.Size(295, 30)
$leftSlider.Minimum = 1
$leftSlider.Maximum = 25
$leftSlider.Value = 10
$leftSlider.TickStyle = "None"
$leftSlider.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
$form.Controls.Add($leftSlider)

# Right Click Row
$rightLabel = New-Object System.Windows.Forms.Label
$rightLabel.Location = New-Object System.Drawing.Point(20, 123)
$rightLabel.Size = New-Object System.Drawing.Size(65, 20)
$rightLabel.Text = "Right click"
$rightLabel.ForeColor = [System.Drawing.Color]::FromArgb(130, 130, 130)
$rightLabel.Font = New-Object System.Drawing.Font("Arial", 9)
$form.Controls.Add($rightLabel)

$rightKeyLabel = New-Object System.Windows.Forms.Label
$rightKeyLabel.Location = New-Object System.Drawing.Point(100, 120)
$rightKeyLabel.Size = New-Object System.Drawing.Size(80, 26)
$rightKeyLabel.Text = "none"
$rightKeyLabel.ForeColor = [System.Drawing.Color]::FromArgb(100, 100, 100)
$rightKeyLabel.Font = New-Object System.Drawing.Font("Arial", 10)
$rightKeyLabel.Cursor = [System.Windows.Forms.Cursors]::Hand
$rightKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
$rightKeyLabel.TextAlign = "MiddleCenter"
$form.Controls.Add($rightKeyLabel)

$rightCpsLabel = New-Object System.Windows.Forms.Label
$rightCpsLabel.Location = New-Object System.Drawing.Point(280, 123)
$rightCpsLabel.Size = New-Object System.Drawing.Size(35, 20)
$rightCpsLabel.Text = "10"
$rightCpsLabel.ForeColor = [System.Drawing.Color]::White
$rightCpsLabel.Font = New-Object System.Drawing.Font("Arial", 11, [System.Drawing.FontStyle]::Bold)
$rightCpsLabel.TextAlign = "MiddleRight"
$form.Controls.Add($rightCpsLabel)

$rightSlider = New-Object System.Windows.Forms.TrackBar
$rightSlider.Location = New-Object System.Drawing.Point(20, 148)
$rightSlider.Size = New-Object System.Drawing.Size(295, 30)
$rightSlider.Minimum = 1
$rightSlider.Maximum = 25
$rightSlider.Value = 10
$rightSlider.TickStyle = "None"
$rightSlider.BackColor = [System.Drawing.Color]::FromArgb(15, 15, 15)
$form.Controls.Add($rightSlider)

# Stealth Mode Toggle Button
$stealthBtn = New-Object System.Windows.Forms.Button
$stealthBtn.Location = New-Object System.Drawing.Point(20, 188)
$stealthBtn.Size = New-Object System.Drawing.Size(295, 28)
$stealthBtn.Text = "Stealth Mode: OFF"
$stealthBtn.BackColor = [System.Drawing.Color]::FromArgb(60, 60, 20)
$stealthBtn.ForeColor = [System.Drawing.Color]::FromArgb(255, 200, 100)
$stealthBtn.FlatStyle = "Flat"
$stealthBtn.FlatAppearance.BorderSize = 0
$stealthBtn.Font = New-Object System.Drawing.Font("Arial", 9, [System.Drawing.FontStyle]::Bold)
$stealthBtn.Cursor = [System.Windows.Forms.Cursors]::Hand
$form.Controls.Add($stealthBtn)

# Self Destruct Button
$selfDestructBtn = New-Object System.Windows.Forms.Button
$selfDestructBtn.Location = New-Object System.Drawing.Point(20, 222)
$selfDestructBtn.Size = New-Object System.Drawing.Size(295, 28)
$selfDestructBtn.Text = "SELF DESTRUCT"
$selfDestructBtn.BackColor = [System.Drawing.Color]::FromArgb(100, 20, 20)
$selfDestructBtn.ForeColor = [System.Drawing.Color]::FromArgb(255, 100, 100)
$selfDestructBtn.FlatStyle = "Flat"
$selfDestructBtn.FlatAppearance.BorderSize = 0
$selfDestructBtn.Font = New-Object System.Drawing.Font("Arial", 9, [System.Drawing.FontStyle]::Bold)
$selfDestructBtn.Cursor = [System.Windows.Forms.Cursors]::Hand
$form.Controls.Add($selfDestructBtn)

# Event Handlers
$leftKeyLabel.Add_Click({
    $leftKeyLabel.Text = "..."
    $leftKeyLabel.ForeColor = [System.Drawing.Color]::FromArgb(220, 50, 50)
    $leftKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(40, 15, 15)
    $script:leftListeningMode = $true
})

$rightKeyLabel.Add_Click({
    $rightKeyLabel.Text = "..."
    $rightKeyLabel.ForeColor = [System.Drawing.Color]::FromArgb(220, 50, 50)
    $rightKeyLabel.BackColor = [System.Drawing.Color]::FromArgb(40, 15, 15)
    $script:rightListeningMode = $true
})

$leftSlider.Add_ValueChanged({
    $leftCpsLabel.Text = $leftSlider.Value.ToString()
    $interval = 1000.0 / [double]$leftSlider.Value
    $script:leftClickTimer.Interval = [Math]::Max(1, [int]$interval)
})

$rightSlider.Add_ValueChanged({
    $rightCpsLabel.Text = $rightSlider.Value.ToString()
    $interval = 1000.0 / [double]$rightSlider.Value
    $script:rightClickTimer.Interval = [Math]::Max(1, [int]$interval)
})

$discordBtn.Add_Click({
    Start-Process "https://discord.gg/zP43MEEc3A"
})

$closeBtn.Add_Click({
    $form.Close()
})

$closeBtn.Add_MouseEnter({
    $closeBtn.ForeColor = [System.Drawing.Color]::FromArgb(220, 50, 50)
})

$closeBtn.Add_MouseLeave({
    $closeBtn.ForeColor = [System.Drawing.Color]::White
})

$stealthBtn.Add_Click({
    $script:stealthMode = -not $script:stealthMode
    
    if ($script:stealthMode) {
        $stealthBtn.Text = "Stealth Mode: ON"
        $stealthBtn.BackColor = [System.Drawing.Color]::FromArgb(20, 60, 20)
        $stealthBtn.ForeColor = [System.Drawing.Color]::FromArgb(100, 255, 100)
        
        try {
            $hwnd = $form.Handle
            
            # Ocultar de Alt+Tab
            $currentStyle = [NativeMethods]::GetWindowLong($hwnd, [NativeMethods]::GWL_EXSTYLE)
            $newStyle = $currentStyle -bor [NativeMethods]::WS_EX_TOOLWINDOW -bor [NativeMethods]::WS_EX_NOACTIVATE
            [NativeMethods]::SetWindowLong($hwnd, [NativeMethods]::GWL_EXSTYLE, $newStyle) | Out-Null
            
            # M煤ltiples m茅todos para ocultar de capturas
            try {
                $value = 1
                [NativeMethods]::DwmSetWindowAttribute($hwnd, [NativeMethods]::DWMWA_EXCLUDED_FROM_PEEK, [ref]$value, 4) | Out-Null
                [NativeMethods]::DwmSetWindowAttribute($hwnd, [NativeMethods]::DWMWA_CLOAK, [ref]$value, 4) | Out-Null
            } catch {}
            
            $form.ShowInTaskbar = $false
            $form.TopMost = $true
            $form.Hide()
            $form.Show()
        } catch {}
    } else {
        $stealthBtn.Text = "Stealth Mode: OFF"
        $stealthBtn.BackColor = [System.Drawing.Color]::FromArgb(60, 60, 20)
        $stealthBtn.ForeColor = [System.Drawing.Color]::FromArgb(255, 200, 100)
        
        try {
            $hwnd = $form.Handle
            
            # Mostrar en Alt+Tab
            $currentStyle = [NativeMethods]::GetWindowLong($hwnd, [NativeMethods]::GWL_EXSTYLE)
            $newStyle = $currentStyle -band (-bnot [NativeMethods]::WS_EX_TOOLWINDOW) -band (-bnot [NativeMethods]::WS_EX_NOACTIVATE)
            [NativeMethods]::SetWindowLong($hwnd, [NativeMethods]::GWL_EXSTYLE, $newStyle) | Out-Null
            
            try {
                $value = 0
                [NativeMethods]::DwmSetWindowAttribute($hwnd, [NativeMethods]::DWMWA_EXCLUDED_FROM_PEEK, [ref]$value, 4) | Out-Null
                [NativeMethods]::DwmSetWindowAttribute($hwnd, [NativeMethods]::DWMWA_CLOAK, [ref]$value, 4) | Out-Null
            } catch {}
            
            $form.ShowInTaskbar = $true
            $form.TopMost = $false
            $form.Hide()
            $form.Show()
        } catch {}
    }
})

$selfDestructBtn.Add_Click({
    $result = [System.Windows.Forms.MessageBox]::Show(
        "Close everything?",
        "Self Destruct",
        [System.Windows.Forms.MessageBoxButtons]::YesNo,
        [System.Windows.Forms.MessageBoxIcon]::Warning
    )
    
    if ($result -eq [System.Windows.Forms.DialogResult]::Yes) {
        $selfDestructBtn.Text = "DESTRUCTING..."
        $selfDestructBtn.BackColor = [System.Drawing.Color]::FromArgb(150, 20, 20)
        $form.Refresh()
        Start-Sleep -Milliseconds 300
        
        $script:leftClickTimer.Stop()
        $script:rightClickTimer.Stop()
        $script:keyMonitorTimer.Stop()
        
        try {
            Get-Process | Where-Object { $_.ProcessName -eq "powershell" -or $_.ProcessName -eq "pwsh" } | ForEach-Object {
                if ($_.Id -ne $PID) {
                    Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue
                }
            }
            
            Get-Process | Where-Object { $_.ProcessName -eq "cmd" } | ForEach-Object {
                Stop-Process -Id $_.Id -Force -ErrorAction SilentlyContinue
            }
        } catch {}
        
        $form.Close()
        Stop-Process -Id $PID -Force
    }
})

# Configurar timers
$script:leftClickTimer.Add_Tick({ Invoke-LeftClick })
$script:rightClickTimer.Add_Tick({ Invoke-RightClick })
$script:leftClickTimer.Interval = 100
$script:rightClickTimer.Interval = 100

$script:keyMonitorTimer.Interval = 10
$script:keyMonitorTimer.Add_Tick({ Update-KeyStates })
$script:keyMonitorTimer.Start()

$form.Add_FormClosing({
    $script:leftClickTimer.Stop()
    $script:rightClickTimer.Stop()
    $script:keyMonitorTimer.Stop()
    $script:leftClickTimer.Dispose()
    $script:rightClickTimer.Dispose()
    $script:keyMonitorTimer.Dispose()
})

# Ejecutar la aplicaci贸n
[System.Windows.Forms.Application]::Run($form)
