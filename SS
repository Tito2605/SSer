# Forzar modo STA
if ($host.Runspace.ApartmentState -ne "STA") {
    powershell -STA -ExecutionPolicy Bypass -File $PSCommandPath
    exit
}

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# API de Windows
try {
    Add-Type @"
using System;
using System.Runtime.InteropServices;
public class NativeMethods {
    [DllImport("user32.dll")]
    public static extern void mouse_event(int dwFlags, int dx, int dy, int dwData, int dwExtraInfo);
    
    [DllImport("user32.dll")]
    public static extern short GetAsyncKeyState(int vKey);
    
    [DllImport("user32.dll", SetLastError = true)]
    public static extern int SetWindowLong(IntPtr hWnd, int nIndex, int dwNewLong);
    
    [DllImport("user32.dll", SetLastError = true)]
    public static extern int GetWindowLong(IntPtr hWnd, int nIndex);
    
    [DllImport("dwmapi.dll", PreserveSig = true)]
    public static extern int DwmSetWindowAttribute(IntPtr hwnd, int attr, ref int attrValue, int attrSize);
    
    public const int MOUSEEVENTF_LEFTDOWN = 0x02;
    public const int MOUSEEVENTF_LEFTUP = 0x04;
    public const int MOUSEEVENTF_RIGHTDOWN = 0x08;
    public const int MOUSEEVENTF_RIGHTUP = 0x10;
    
    public const int GWL_EXSTYLE = -20;
    public const int WS_EX_TOOLWINDOW = 0x00000080;
    public const int WS_EX_NOACTIVATE = 0x08000000;
    public const int DWMWA_EXCLUDED_FROM_PEEK = 12;
    public const int DWMWA_CLOAK = 13;
}
"@
} catch {}

# Variables
$script:leftTimer = New-Object System.Windows.Forms.Timer
$script:rightTimer = New-Object System.Windows.Forms.Timer
$script:monitorTimer = New-Object System.Windows.Forms.Timer
$script:leftKey = 0
$script:rightKey = 0
$script:leftActive = $false
$script:rightActive = $false
$script:leftWasPressed = $false
$script:rightWasPressed = $false
$script:leftListening = $false
$script:rightListening = $false
$script:stealthMode = $false

function Get-KeyName {
    param([int]$code)
    $names = @{
        0x01="LMB";0x02="RMB";0x04="MMB";0x05="MB4";0x06="MB5"
        0x20="Space";0x10="Shift";0x11="Ctrl";0x12="Alt"
        0x41="A";0x42="B";0x43="C";0x44="D";0x45="E";0x46="F";0x47="G"
        0x48="H";0x49="I";0x4A="J";0x4B="K";0x4C="L";0x4D="M";0x4E="N"
        0x4F="O";0x50="P";0x51="Q";0x52="R";0x53="S";0x54="T";0x55="U"
        0x56="V";0x57="W";0x58="X";0x59="Y";0x5A="Z"
        0x70="F1";0x71="F2";0x72="F3";0x73="F4";0x74="F5";0x75="F6"
    }
    if($names.ContainsKey($code)){return $names[$code]}
    return "Key"
}

function Get-PressedKey {
    for($i=1;$i -le 254;$i++){
        if(([NativeMethods]::GetAsyncKeyState($i) -band 0x8000) -ne 0){return $i}
    }
    return 0
}

function Do-LeftClick {
    [NativeMethods]::mouse_event(2,0,0,0,0)
    [NativeMethods]::mouse_event(4,0,0,0,0)
}

function Do-RightClick {
    [NativeMethods]::mouse_event(8,0,0,0,0)
    [NativeMethods]::mouse_event(16,0,0,0,0)
}

function Update-Monitor {
    # Left
    if($script:leftActive -and $script:leftKey -ne 0){
        $pressed = ([NativeMethods]::GetAsyncKeyState($script:leftKey) -band 0x8000) -ne 0
        if($pressed -and -not $script:leftWasPressed){
            $script:leftTimer.Start()
        }
        elseif(-not $pressed -and $script:leftWasPressed){
            $script:leftTimer.Stop()
        }
        $script:leftWasPressed = $pressed
    }
    
    # Right
    if($script:rightActive -and $script:rightKey -ne 0){
        $pressed = ([NativeMethods]::GetAsyncKeyState($script:rightKey) -band 0x8000) -ne 0
        if($pressed -and -not $script:rightWasPressed){
            $script:rightTimer.Start()
        }
        elseif(-not $pressed -and $script:rightWasPressed){
            $script:rightTimer.Stop()
        }
        $script:rightWasPressed = $pressed
    }
    
    # Listen Left
    if($script:leftListening){
        $key = Get-PressedKey
        if($key -ne 0){
            if($key -eq 0x1B){
                $script:leftKey = 0
                $leftKeyBox.Text = "none"
                $leftKeyBox.ForeColor = [System.Drawing.Color]::Gray
                $script:leftActive = $false
            } else {
                $script:leftKey = $key
                $leftKeyBox.Text = Get-KeyName $key
                $leftKeyBox.ForeColor = [System.Drawing.Color]::White
                $script:leftActive = $true
            }
            $leftKeyBox.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
            $script:leftListening = $false
            Start-Sleep -Milliseconds 200
        }
    }
    
    # Listen Right
    if($script:rightListening){
        $key = Get-PressedKey
        if($key -ne 0){
            if($key -eq 0x1B){
                $script:rightKey = 0
                $rightKeyBox.Text = "none"
                $rightKeyBox.ForeColor = [System.Drawing.Color]::Gray
                $script:rightActive = $false
            } else {
                $script:rightKey = $key
                $rightKeyBox.Text = Get-KeyName $key
                $rightKeyBox.ForeColor = [System.Drawing.Color]::White
                $script:rightActive = $true
            }
            $rightKeyBox.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
            $script:rightListening = $false
            Start-Sleep -Milliseconds 200
        }
    }
}

# Form
$form = New-Object System.Windows.Forms.Form
$form.Text = "Icon1CClicker"
$form.Size = New-Object System.Drawing.Size(340,260)
$form.StartPosition = "CenterScreen"
$form.FormBorderStyle = "None"
$form.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
$form.ShowInTaskbar = $true

# Dragging
$script:drag = $false
$form.Add_MouseDown({
    if($_.Y -lt 40){
        $script:drag = $true
        $script:dragStart = $_.Location
    }
})
$form.Add_MouseMove({
    if($script:drag){
        $pos = $form.PointToScreen($_.Location)
        $form.Location = New-Object System.Drawing.Point($pos.X - $script:dragStart.X, $pos.Y - $script:dragStart.Y)
    }
})
$form.Add_MouseUp({$script:drag = $false})

# Title
$title = New-Object System.Windows.Forms.Label
$title.Location = New-Object System.Drawing.Point(15,12)
$title.Size = New-Object System.Drawing.Size(200,26)
$title.Text = "Icon1CClicker"
$title.Font = New-Object System.Drawing.Font("Consolas",16,[System.Drawing.FontStyle]::Bold)
$title.ForeColor = [System.Drawing.Color]::White
$form.Controls.Add($title)

# Discord SVG simplificado
$discord = New-Object System.Windows.Forms.Label
$discord.Location = New-Object System.Drawing.Point(265,10)
$discord.Size = New-Object System.Drawing.Size(28,28)
$discord.Text = "◆"
$discord.Font = New-Object System.Drawing.Font("Wingdings",18)
$discord.ForeColor = [System.Drawing.Color]::FromArgb(88,101,242)
$discord.TextAlign = "MiddleCenter"
$discord.Cursor = "Hand"
$discord.Add_Click({Start-Process "https://discord.gg/zP43MEEc3A"})
$form.Controls.Add($discord)

# Close
$close = New-Object System.Windows.Forms.Label
$close.Location = New-Object System.Drawing.Point(298,8)
$close.Size = New-Object System.Drawing.Size(32,32)
$close.Text = "×"
$close.Font = New-Object System.Drawing.Font("Arial",22,[System.Drawing.FontStyle]::Bold)
$close.ForeColor = [System.Drawing.Color]::White
$close.TextAlign = "MiddleCenter"
$close.Cursor = "Hand"
$close.Add_Click({$form.Close()})
$close.Add_MouseEnter({$close.ForeColor=[System.Drawing.Color]::FromArgb(220,50,50)})
$close.Add_MouseLeave({$close.ForeColor=[System.Drawing.Color]::White})
$form.Controls.Add($close)

# Left label
$leftLbl = New-Object System.Windows.Forms.Label
$leftLbl.Location = New-Object System.Drawing.Point(20,56)
$leftLbl.Size = New-Object System.Drawing.Size(65,20)
$leftLbl.Text = "Left click"
$leftLbl.ForeColor = [System.Drawing.Color]::FromArgb(130,130,130)
$leftLbl.Font = New-Object System.Drawing.Font("Segoe UI",9)
$form.Controls.Add($leftLbl)

# Left key
$leftKeyBox = New-Object System.Windows.Forms.Label
$leftKeyBox.Location = New-Object System.Drawing.Point(95,53)
$leftKeyBox.Size = New-Object System.Drawing.Size(90,26)
$leftKeyBox.Text = "none"
$leftKeyBox.ForeColor = [System.Drawing.Color]::Gray
$leftKeyBox.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
$leftKeyBox.Font = New-Object System.Drawing.Font("Consolas",11,[System.Drawing.FontStyle]::Bold)
$leftKeyBox.TextAlign = "MiddleCenter"
$leftKeyBox.Cursor = "Hand"
$leftKeyBox.Add_Click({
    $leftKeyBox.Text = "..."
    $leftKeyBox.ForeColor = [System.Drawing.Color]::FromArgb(255,120,120)
    $leftKeyBox.BackColor = [System.Drawing.Color]::FromArgb(30,15,15)
    $script:leftListening = $true
})
$form.Controls.Add($leftKeyBox)

# Left CPS
$leftCps = New-Object System.Windows.Forms.Label
$leftCps.Location = New-Object System.Drawing.Point(285,56)
$leftCps.Size = New-Object System.Drawing.Size(30,20)
$leftCps.Text = "10"
$leftCps.ForeColor = [System.Drawing.Color]::White
$leftCps.Font = New-Object System.Drawing.Font("Consolas",11,[System.Drawing.FontStyle]::Bold)
$leftCps.TextAlign = "MiddleRight"
$form.Controls.Add($leftCps)

# Left slider background
$leftBg = New-Object System.Windows.Forms.Panel
$leftBg.Location = New-Object System.Drawing.Point(20,88)
$leftBg.Size = New-Object System.Drawing.Size(295,3)
$leftBg.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
$form.Controls.Add($leftBg)

# Left slider fill
$leftFill = New-Object System.Windows.Forms.Panel
$leftFill.Location = New-Object System.Drawing.Point(20,88)
$leftFill.Size = New-Object System.Drawing.Size(118,3)
$leftFill.BackColor = [System.Drawing.Color]::FromArgb(88,101,242)
$form.Controls.Add($leftFill)

# Left slider
$leftSlide = New-Object System.Windows.Forms.TrackBar
$leftSlide.Location = New-Object System.Drawing.Point(15,80)
$leftSlide.Size = New-Object System.Drawing.Size(305,35)
$leftSlide.Minimum = 1
$leftSlide.Maximum = 25
$leftSlide.Value = 10
$leftSlide.TickStyle = "None"
$leftSlide.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
$leftSlide.Add_ValueChanged({
    $leftCps.Text = $leftSlide.Value
    $script:leftTimer.Interval = [Math]::Max(1,[int](1000.0/$leftSlide.Value))
    $leftFill.Width = [int](($leftSlide.Value/25.0)*295)
})
$form.Controls.Add($leftSlide)

# Right label
$rightLbl = New-Object System.Windows.Forms.Label
$rightLbl.Location = New-Object System.Drawing.Point(20,121)
$rightLbl.Size = New-Object System.Drawing.Size(65,20)
$rightLbl.Text = "Right click"
$rightLbl.ForeColor = [System.Drawing.Color]::FromArgb(130,130,130)
$rightLbl.Font = New-Object System.Drawing.Font("Segoe UI",9)
$form.Controls.Add($rightLbl)

# Right key
$rightKeyBox = New-Object System.Windows.Forms.Label
$rightKeyBox.Location = New-Object System.Drawing.Point(95,118)
$rightKeyBox.Size = New-Object System.Drawing.Size(90,26)
$rightKeyBox.Text = "none"
$rightKeyBox.ForeColor = [System.Drawing.Color]::Gray
$rightKeyBox.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
$rightKeyBox.Font = New-Object System.Drawing.Font("Consolas",11,[System.Drawing.FontStyle]::Bold)
$rightKeyBox.TextAlign = "MiddleCenter"
$rightKeyBox.Cursor = "Hand"
$rightKeyBox.Add_Click({
    $rightKeyBox.Text = "..."
    $rightKeyBox.ForeColor = [System.Drawing.Color]::FromArgb(255,120,120)
    $rightKeyBox.BackColor = [System.Drawing.Color]::FromArgb(30,15,15)
    $script:rightListening = $true
})
$form.Controls.Add($rightKeyBox)

# Right CPS
$rightCps = New-Object System.Windows.Forms.Label
$rightCps.Location = New-Object System.Drawing.Point(285,121)
$rightCps.Size = New-Object System.Drawing.Size(30,20)
$rightCps.Text = "10"
$rightCps.ForeColor = [System.Drawing.Color]::White
$rightCps.Font = New-Object System.Drawing.Font("Consolas",11,[System.Drawing.FontStyle]::Bold)
$rightCps.TextAlign = "MiddleRight"
$form.Controls.Add($rightCps)

# Right slider background
$rightBg = New-Object System.Windows.Forms.Panel
$rightBg.Location = New-Object System.Drawing.Point(20,153)
$rightBg.Size = New-Object System.Drawing.Size(295,3)
$rightBg.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
$form.Controls.Add($rightBg)

# Right slider fill
$rightFill = New-Object System.Windows.Forms.Panel
$rightFill.Location = New-Object System.Drawing.Point(20,153)
$rightFill.Size = New-Object System.Drawing.Size(118,3)
$rightFill.BackColor = [System.Drawing.Color]::FromArgb(88,101,242)
$form.Controls.Add($rightFill)

# Right slider
$rightSlide = New-Object System.Windows.Forms.TrackBar
$rightSlide.Location = New-Object System.Drawing.Point(15,145)
$rightSlide.Size = New-Object System.Drawing.Size(305,35)
$rightSlide.Minimum = 1
$rightSlide.Maximum = 25
$rightSlide.Value = 10
$rightSlide.TickStyle = "None"
$rightSlide.BackColor = [System.Drawing.Color]::FromArgb(15,15,15)
$rightSlide.Add_ValueChanged({
    $rightCps.Text = $rightSlide.Value
    $script:rightTimer.Interval = [Math]::Max(1,[int](1000.0/$rightSlide.Value))
    $rightFill.Width = [int](($rightSlide.Value/25.0)*295)
})
$form.Controls.Add($rightSlide)

# Stealth
$stealth = New-Object System.Windows.Forms.Button
$stealth.Location = New-Object System.Drawing.Point(20,185)
$stealth.Size = New-Object System.Drawing.Size(295,28)
$stealth.Text = "Stealth Mode: OFF"
$stealth.BackColor = [System.Drawing.Color]::FromArgb(60,60,20)
$stealth.ForeColor = [System.Drawing.Color]::FromArgb(255,200,100)
$stealth.FlatStyle = "Flat"
$stealth.FlatAppearance.BorderSize = 0
$stealth.Font = New-Object System.Drawing.Font("Segoe UI",9,[System.Drawing.FontStyle]::Bold)
$stealth.Cursor = "Hand"
$stealth.Add_Click({
    $script:stealthMode = -not $script:stealthMode
    if($script:stealthMode){
        $stealth.Text = "Stealth Mode: ON"
        $stealth.BackColor = [System.Drawing.Color]::FromArgb(20,60,20)
        $stealth.ForeColor = [System.Drawing.Color]::FromArgb(100,255,100)
        try{
            $h = $form.Handle
            $s = [NativeMethods]::GetWindowLong($h,-20)
            [NativeMethods]::SetWindowLong($h,-20,$s -bor 0x80 -bor 0x08000000)|Out-Null
            $v=1;[NativeMethods]::DwmSetWindowAttribute($h,12,[ref]$v,4)|Out-Null
            $form.ShowInTaskbar=$false;$form.Hide();$form.Show()
        }catch{}
    }else{
        $stealth.Text = "Stealth Mode: OFF"
        $stealth.BackColor = [System.Drawing.Color]::FromArgb(60,60,20)
        $stealth.ForeColor = [System.Drawing.Color]::FromArgb(255,200,100)
        try{
            $h = $form.Handle
            $s = [NativeMethods]::GetWindowLong($h,-20)
            [NativeMethods]::SetWindowLong($h,-20,$s -band (-bnot 0x80))|Out-Null
            $v=0;[NativeMethods]::DwmSetWindowAttribute($h,12,[ref]$v,4)|Out-Null
            $form.ShowInTaskbar=$true;$form.Hide();$form.Show()
        }catch{}
    }
})
$form.Controls.Add($stealth)

# Self Destruct
$destruct = New-Object System.Windows.Forms.Button
$destruct.Location = New-Object System.Drawing.Point(20,218)
$destruct.Size = New-Object System.Drawing.Size(295,28)
$destruct.Text = "SELF DESTRUCT"
$destruct.BackColor = [System.Drawing.Color]::FromArgb(100,20,20)
$destruct.ForeColor = [System.Drawing.Color]::FromArgb(255,100,100)
$destruct.FlatStyle = "Flat"
$destruct.FlatAppearance.BorderSize = 0
$destruct.Font = New-Object System.Drawing.Font("Segoe UI",9,[System.Drawing.FontStyle]::Bold)
$destruct.Cursor = "Hand"
$destruct.Add_Click({
    if([System.Windows.Forms.MessageBox]::Show("Close everything?","Self Destruct","YesNo","Warning") -eq "Yes"){
        $script:leftTimer.Stop();$script:rightTimer.Stop();$script:monitorTimer.Stop()
        try{
            Get-Process|?{$_.ProcessName -match "powershell|pwsh|cmd" -and $_.Id -ne $PID}|%{Stop-Process $_.Id -Force -EA 0}
        }catch{}
        $form.Close();Stop-Process -Id $PID -Force
    }
})
$form.Controls.Add($destruct)

# Timers
$script:leftTimer.Add_Tick({Do-LeftClick})
$script:rightTimer.Add_Tick({Do-RightClick})
$script:leftTimer.Interval = 100
$script:rightTimer.Interval = 100
$script:monitorTimer.Interval = 10
$script:monitorTimer.Add_Tick({Update-Monitor})
$script:monitorTimer.Start()

$form.Add_FormClosing({
    $script:leftTimer.Dispose()
    $script:rightTimer.Dispose()
    $script:monitorTimer.Dispose()
})

[System.Windows.Forms.Application]::Run($form)
